---
import { convertDate } from '../../../lib/convertDate'

interface Props {
    month? : string
}

const { 
    month = convertDate().to('YYYY-MM')
} = Astro.props

---

<monthly-spending-summary month={month}>
    
    <budget-total class="relative rounded-sm flex items-center justify-between py-2 pb-4 min-w-fit">
        <!-- <span>
            ğŸ—“ï¸ {convertDate(month).to('MMMM-YYYY')}
        </span> -->

        <monthly-spending-total class="text-lg font-semibold min-w-fit" />

        <span 
            class:list={[
                "absolute left-0 bottom-0 h-3.75 -z-10 rounded-lg block bg-blue/60 scale-y-105 origin-left",
                'progress-bar animate-progress-bar',
            ]}
        />
    </budget-total>

</monthly-spending-summary>


<script>
import { actions } from "astro:actions";
import { el, } from "../../../lib/el";


class MonthlySpendingSummary extends HTMLElement {

    private budgetList : HTMLElement | null = null
    private month : string | null = null

    async connectedCallback() {
        this.budgetList = el('#budget-list')
        this.month = this.getAttribute('month')

        /**
         * Observe changes to budgetList if it exists as we want to update the total of all budgets if 1 is changed. If no budgetList, then just render the component without and observer
         */
        if( this.budgetList ) {
            this.observeBudgetList()
        }

        this.updateSpendingSummary()
    }

    /**
     * Budget-List mutation observer
     */
    observeBudgetList() {

        const observer = new MutationObserver( async () => {
            this.updateSpendingSummary()            
        })
        
        observer.observe( this.budgetList as Node, {
            childList : true,
            attributes : false,
            subtree : true,
        })
    }

    /**
     * Fetch and Render monthly spending data
     */
    async updateSpendingSummary() {
        const response = await actions.summary.getMonthlySpending({date : this.month})

        if( !response.data ) {
            return
        }

        el('monthly-spending-total', this, el => {
            el.textContent = String(`${response.data.spent} / ${response.data.budgets} spent so far`)
        })

        el<HTMLSpanElement>('span.progress-bar', this, el => {
            const percent = Math.min(
                Math.round( response.data.spent / response.data.budgets * 100 ),
                100
            )
            el.style.width = `${percent}%` 
        })
    }
}

customElements.define('monthly-spending-summary', MonthlySpendingSummary)

</script>