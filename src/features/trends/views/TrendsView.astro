---
import { actions } from "astro:actions"
import H1 from "../../../components/H1.astro"
import AppLayout from "../../../layouts/AppLayout.astro"
import GraphTitle from "../components/GraphTitle.astro"
import { calcSpendingTotals, calcUpperRange, calcMonthRange } from "../utils/trendGraph.utils"
import BudgetGraph from "../components/BudgetGraph.astro"
import type { Transaction } from "../../transactions/schema/transaction.schema"
import SpendingGraph from "../components/SpendingGraph.astro"
import IncomeGraph from "../components/IncomeGraph.astro"
import NetGraph from "../components/NetGraph.astro"

const [transactions, budgets] = await Promise.all([
    Astro.callAction(actions.transaction.index, { filter: "all" }),
    Astro.callAction(actions.budget.index, {}),
])

const spendingTotals = calcSpendingTotals(transactions.data.list)
const spendingUpperRange = calcUpperRange(spendingTotals, 'spending')
const incomeUpperRange = calcUpperRange(spendingTotals, 'income')
const netUpperRange = calcUpperRange(spendingTotals, 'net')
const monthRange = calcMonthRange(spendingTotals)
---

<AppLayout>

    <H1> Trends </H1>

    <SpendingGraph
        monthRange={monthRange}
        spendingTotals={spendingTotals}
        upperRange={spendingUpperRange}
     />

    <IncomeGraph 
        monthRange={monthRange}
        spendingTotals={spendingTotals}
        upperRange={incomeUpperRange}
    />

    <NetGraph 
        monthRange={monthRange}
        spendingTotals={spendingTotals}
        upperRange={netUpperRange}
    />

    <!-- Make this interactive -->
    <div class="grid gap-4 mt-12 ">

        <GraphTitle title="Budgets Trends over time" />

        { budgets.data?.map( budget => (
            <BudgetGraph 
                budgetName={budget.name}
                transactions={transactions.data.list.filter( (t: Transaction) => t.budget === budget.name )}
            />
        ))}
    </div>
</AppLayout>
