---
import { actions } from "astro:actions"
import TransactionListLayout from "../../../layouts/TransactionListLayout.astro"
import TransactionList from "../components/TransactionList"
import type { Transaction as TransactionSchema } from "../schema/transaction.schema"
import type { Account } from "../../settings/accounts.schema"

const budgetId = Number(Astro.props.routeParam)
const budgets = await Astro.callAction( actions.budget.index, {} )
const budgetName = !budgets.error 
	? budgets.data?.find( b => b.id === budgetId )?.name
	: undefined

let transactions: TransactionSchema[] = []
let accounts : Account[] = []

if( budgetId ) {

	const [transactionsResult, accountsResult] = await Promise.all([
		Astro.callAction(actions.transaction.byBudget, { budgetId }),
		Astro.callAction(actions.accounts.index, {}),
	])

	if ( !transactionsResult.error ) {
		transactions = transactionsResult.data.list
	}

	if ( !accountsResult.error ) {
		accounts = accountsResult.data
	}
}

---

<TransactionListLayout
	title={ budgetName || 'Select a Budget' }
	active="budget"
>

	<select 
		id="budget-selector"
		name="budget-selector" 
		class="w-full md:max-w-fit mb-4"
		data-budget={budgetId}
	>
		<option>Select budget to view</option>
		<option value="null">Uncategorized</option>
		{ budgets.data?.map( budget => (
			<option value={budget.id}>
				{budget.name}
			</option>
		))}
	</select>

	<TransactionList
		transactions={transactions}
		budgets={budgets.data ?? []}
		accounts={accounts}
		client:only="react"
	/>

</TransactionListLayout>


<script>
import { el } from "../../../lib/el"

document.addEventListener('DOMContentLoaded', () => {

	/**
	 * Select onChange handler
	 * Navigate to new transaction budget page
	 */
	el<HTMLSelectElement>('#budget-selector', document, select => {
		select.addEventListener('change', e => {

			if( !(e.target instanceof HTMLSelectElement) ) {
				return
			}

			if( e.target.dataset.budget === e.target.value ) {
				return
			}

			window.location.href = `/transactions/budget/${e.target.value}`
		})
	})

})
</script>

