---
interface Props {
	data : {
		label : string,
		amount : number
	}[]
}

const {	data } = Astro.props

const size = 220
const strokeWidth = 15
const radius = (size - strokeWidth) / 2;
const circumference = 2 * Math.PI * radius;
const center = size / 2;

const total = data.reduce((sum, s) => sum + s.amount, 0);

let dashOffset = 0;
let angleCursor = 0;
const gap = strokeWidth * 1.6;
---

<svg
	width={size}
	height={size}
	viewBox={`0 0 ${size} ${size}`}
	role="img"
	aria-label="Pie chart"
	class="overflow-visible mx-auto pointer-events-none w-fit max-w-48.75 sm:max-w-none"
>
	<!-- Rotate so chart starts at 12 o’clock -->
	<g transform={`rotate(-90 ${center} ${center})`}>
		{
			data.map((slice, i) => {

				const fraction = slice.amount / total

				const rawDash = fraction * circumference
				const adjustedDash = Math.max(rawDash - gap, 0)

				const dashArray = `${adjustedDash} ${circumference - adjustedDash}`

				const currentOffset = dashOffset
				dashOffset -= rawDash

				return (
					<circle
						cx={center}
						cy={center}
						r={radius}
						fill="transparent"
						stroke-width={strokeWidth}
						stroke-dasharray={dashArray}
						stroke-dashoffset={currentOffset}
						stroke-linecap="round"
						class:list={[
							i === 0 && 'stroke-red/30',
							i === 1 && 'stroke-green/30',
							i === 2 && 'stroke-blue/30',
							i === 3 && 'stroke-orange/30',
							i === 4 && 'stroke-purple/30',
							i === 5 && 'stroke-slate-400/30',
							i === 6 && 'stroke-red/50',
							i === 7 && 'stroke-green/50',
							i === 8 && 'stroke-blue/50',
							i === 9 && 'stroke-orange/50',
							i === 9 && 'stroke-purple/50',
						]}
					/>
				);
			})
		}
	</g>

	<!-- Percentage labels -->
	<!-- {
		data.map((slice, i) => {
			const fraction = slice.amount / total

			// Mid-angle of slice (same math you already use)
			const midAngle = angleCursor + fraction * Math.PI
			angleCursor += fraction * Math.PI * 2

			// Label position (existing logic)
			const labelRadius = radius + strokeWidth * 2

			const labelX = center + Math.cos(midAngle - Math.PI / 2) * labelRadius
			const labelY = center + Math.sin(midAngle - Math.PI / 2) * labelRadius

			console.log({labelX, labelY, ...slice})

			return (
				<text
					x={labelX}
					y={labelY}
					text-anchor="middle"
					dominant-baseline="middle"
					class:list={[
						"font-theme font-semibold text-sm",
							i === 0 && 'fill-red',
							i === 1 && 'fill-green',
							i === 2 && 'fill-blue',
							i === 3 && 'fill-orange',
							i === 4 && 'fill-purple',
							i === 5 && 'fill-slate-400',
							i === 6 && 'fill-red',
							i === 7 && 'fill-green',
							i === 8 && 'fill-blue',
							i === 9 && 'fill-orange',
							i === 10 && 'fill-purple',
					]}
				>
					{slice.label} ● {Math.round(fraction * 100)}%
				</text>
			);
		})
	} -->


</svg>

<style>
	circle {
		animation: draw 30ms cubic-bezier(0.16, 1, 0.3, 1) forwards;
		transform-origin: center;
	}

	circle, text {
		animation: draw 750ms cubic-bezier(0.16, 1, 0.3, 1) forwards;
		transform-origin: bottom;
	}

	@keyframes draw {
		from {
			transform: scale(0);
		}
		to {
			transform: scale(1);
		}
	}
</style>
