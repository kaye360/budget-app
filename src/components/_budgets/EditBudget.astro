---
import { ChartPieIcon } from "@lucide/astro";
import LoadingButton from "../Button/LoadingButton.astro";
import type { Budget } from "../../types/types";

interface Props {
    budget : Budget
}

const { budget } = Astro.props
---

<budget-edit>
    <form 
        class="grid gap-4 font-normal" 
        autocomplete="off"
        method="POST"
        data-budgetid={budget.id}
    >
        <label>
            Name: <br />
            <input type="text" name="name" value={budget.name} required />
        </label>
        <label>
            Amount per month: <br />
            <input type="number" name="amount" value={budget.amount} required />
        </label>
        <LoadingButton 
            type="submit" 
            variant="fill" 
            class="w-full"
            Icon={ChartPieIcon}
            state={{
                initial : 'Update Budget',
                loading : 'Updating...',
                error : 'Something went wrong',
                success : 'Budget Updated!'
            }}
        />
    </form>
</budget-edit>


<script>
import { el } from "../../lib/el"
import { fetchData } from "../../lib/fetch"


class BudgetEdit extends HTMLElement {
    
    /**
     * 
     * Edits a Budget and updates DOM
     * 
     */
    connectedCallback() {

        /**
         * Form submit handler
         */
        el<HTMLFormElement>('form', this, form => {
            form.addEventListener('submit', async (e: Event) => {
        
                e.preventDefault()
                
                if( !(form instanceof HTMLFormElement) ) return 
                
                const button = el<HTMLButtonElement>('loading-button', this)
                button?.setAttribute('state', 'loading')

                const formData = new FormData(form)
                const name = formData.get('name')
                const amount = formData.get('amount')

                const result = await fetchData(`/api/budgets/${form.dataset.budgetid}`, {
                    method : 'PUT',
                    body: { name, amount }
                })

                if( result.error ) {
                    button?.setAttribute('state', 'error')
                    return 
                }
                
                const budget = this.closest('budget-item')
                const prevState = JSON.parse( String( budget?.getAttribute('state') ) )

                budget?.setAttribute('state', JSON.stringify({
                    ...prevState, name, amount
                }))

                button?.setAttribute('state', 'success')
            })
        })
    }
}

customElements.define('budget-edit', BudgetEdit)

</script>