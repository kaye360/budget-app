---
import HomeView from "../features/static/HomeView.astro"
import Error404View from "../features/static/Error404View.astro"
import DashboardView from "../features/dashboard/DashboardView.astro"
import * as Transactions from  '../features/transactions/views/'
import LogoutView from "../features/auth/LogoutView.astro"
import LoginView from "../features/auth/LoginView.astro"
import type { AstroComponentFactory } from "astro/runtime/server/index.js"
import Error401View from "../features/static/Error401View.astro"
import { isAuth } from "../features/auth/auth.utils"
import BudgetsView from "../features/budgets/views/BudgetsView.astro"
import TrendsView from "../features/trends/views/TrendsView.astro"
import BudgetView from "../features/budgets/views/BudgetView.astro"
import SettingsView from "../features/settings/SettingsView.astro"

const auth = await isAuth(Astro)

type Route = keyof typeof routes

const routes = {
    "/index" : HomeView,
    "/dashboard" : DashboardView,
    "/transactions/add" : Transactions.AddView,
    "/transactions/account" : Transactions.AccountView,
    "/transactions/budget" : Transactions.BudgetView,
    "/transactions/deleted" : Transactions.DeletedView,
    "/transactions/import" : Transactions.ImportView,
    "/transactions/month" : Transactions.MonthView,
    "/transactions/month/:month" : Transactions.MonthView,
    "/transactions/recent" : Transactions.RecentView,
    "/transactions" : Transactions.RecentView,
    "/transactions/search" : Transactions.SearchView,
    "/transactions/uncategorized" : Transactions.UncategorizedView,
    "/budgets" : BudgetsView,
    "/budgets/month" : BudgetsView,
    "/budgets/budget" : BudgetView,
    "/trends" : TrendsView,
    "/settings" : SettingsView,
    "/auth/login" : LoginView,
    "/auth/logout" : LogoutView,
    "/404" : Error404View
} as const

const publicRoutes: Route[] = [
    "/index",
    "/auth/login",
]

const props : { routeParam? : string } = { routeParam : undefined } 
const { route = 'index' } = Astro.params
const path = '/' + route as Route
const routeMatches = (Object.keys(routes) as Route[]).filter( key => path.includes(key) )

const isValidRoute = (path: string): path is Route => routeMatches.length > 0
const isPublicRoute = (path: Route) => publicRoutes.includes(path)

const View = ( () => {
    switch(true) {
    
        case !isValidRoute(path):
            Astro.response.status = 404
            return Error404View
        
        case isPublicRoute(path) || !!auth:

            const matchedRoute = routeMatches.sort( (a,b) => b.length - a.length )[0]
            const pathArray = path.split('/')
            const matchRouteArray = matchedRoute.split('/')

            if( pathArray.length > matchRouteArray.length ) {
                props.routeParam = pathArray.at(-1)
            }

            return routes[matchedRoute]

        case !isPublicRoute(path) && !auth:
            Astro.response.status = 401
            return Error401View

        default: 
            return Error404View
    }
})() as AstroComponentFactory

---

<View {...props} />