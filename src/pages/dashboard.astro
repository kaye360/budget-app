---
import Layout from "../layouts/Layout.astro";
import { ArrowLeftRightIcon, BotIcon, ChartColumnIncreasingIcon, MoveRightIcon } from "@lucide/astro"
import Transaction from "../components/_transactions/Transaction.astro";
import type { GetBudgets, RecentTransactions, Transaction as TransactionType } from "../types/types";
import { fetchData } from "../lib/fetch";
import { convertDate } from "../lib/convertDate";
import MonthlySpendingSummary from "../components/_summaries/MonthlySpendingSummary.astro";

const auth = await Astro.session?.get('auth')

if( !auth ) {
    return Astro.redirect('/')
}

const [transactions, budgets] = await Promise.all([
	fetchData<RecentTransactions>('/api/transactions/recent?perPage=5'),
	fetchData<GetBudgets>('/api/budgets'),
])

---
<Layout>

	<div class="text-2xl mb-16 mt-12 flex items-center gap-2 font-theme">
		<BotIcon width="36" height="36" />
		Welcome Back {auth.userName}!
	</div>

	<div class="grid md:grid-cols-2 gap-8">

		<div class="md:col-span-2 grid gap-6 border-b border-slate-300 pb-4">
			<h2 class="flex items-center gap-2 font-semibold">
				<ChartColumnIncreasingIcon />
				Your Spending this month: 
				<span class="italic text-sm">({convertDate().to('MMM-YYYY')})</span>
			</h2>
			<MonthlySpendingSummary />
			<a href="/budgets" class="flex items-center gap-2 justify-self-start">
				View your budgets 
				<MoveRightIcon />
			</a>
		</div>

		<div class="bg-blue/5 rounded-sm p-4">
			<h2 class="flex items-center gap-2 font-semibold tex-2xl mb-6">
				<ArrowLeftRightIcon />
				Recent Transactions
			</h2>
			<transaction-list class="grid">
				{ 
					transactions.response?.data.map( (transaction : TransactionType) =>
						<Transaction {transaction} budgets={budgets.response?.data} mode="simple" />
					)
				}
			</transaction-list>
		</div>


		<div class="bg-blue/10 rounded-sm p-4 min-h-32">Debt</div>
		<div class="bg-blue/10 rounded-sm p-4 min-h-32">Income</div>
		<div class="bg-blue/10 rounded-sm p-4 min-h-32">
			Upcoming Bills
		</div>
	</div>
</Layout>